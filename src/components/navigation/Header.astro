---
import { getCollection } from 'astro:content';
import MobileMenu from './MobileMenu.astro';
import DropdownMenu from './DropdownMenu.astro';
import LanguageSwitcher from '../LanguageSwitcher.astro';
import type { SupportedLanguage } from '../../i18n/config';
import { getLanguageFromUrl } from '../../i18n/utils';
import { t } from '../../i18n/translations';

// Get current language
const lang: SupportedLanguage = Astro.currentLocale as SupportedLanguage || getLanguageFromUrl(Astro.url);

// Auto-generate service dropdown items from services collection
const allServices = await getCollection('services');
const services = allServices.filter(service => service.data.lang === lang);
const serviceItems = [
  ...services
    .sort((a, b) => a.data.base.name.localeCompare(b.data.base.name))
    .map(service => ({
      label: `${service.data.base.name} ${t(lang, 'nav.review')}`,
      href: `/${lang}/services/${service.data.base.id}`
    })),
  { divider: true },
  { label: t(lang, 'nav.allServices'), href: `/${lang}/services` },
];

// Auto-generate occasion dropdown items from occasions collection
const allOccasions = await getCollection('occasions');
const occasions = allOccasions.filter(occasion => occasion.data.lang === lang);
const occasionItems = [
  ...occasions
    .sort((a, b) => a.data.base.name.localeCompare(b.data.base.name))
    .map(occasion => ({
      label: `${occasion.data.base.name} ${t(lang, 'nav.flowers')}`,
      href: `/${lang}/occasions/${occasion.data.base.id}`
    })),
  { divider: true },
  { label: t(lang, 'nav.allOccasions'), href: `/${lang}/occasions` },
];
---

<header class="bg-florize-green text-white py-4 shadow-md">
  <nav class="container mx-auto px-4">
    <div class="flex items-center justify-between">
      <a href={`/${lang}`} class="flex items-center">
        <img
          src="/images/florizeflowers-logo-white.svg"
          alt="Florize Flowers - UK Flower Delivery Reviews"
          class="h-10 w-auto"
        />
      </a>

      <!-- Desktop Navigation -->
      <ul class="hidden md:flex gap-6 items-center">
        <li><a href={`/${lang}`} class="hover:text-bloom-pink transition-colors">{t(lang, 'nav.home')}</a></li>
        <li>
          <DropdownMenu
            label={t(lang, 'nav.services')}
            href={`/${lang}/services`}
            items={serviceItems}
          />
        </li>
        <li>
          <DropdownMenu
            label={t(lang, 'nav.occasions')}
            href={`/${lang}/occasions`}
            items={occasionItems}
          />
        </li>
        <li><a href={`/${lang}/guides`} class="hover:text-bloom-pink transition-colors">{t(lang, 'nav.guides')}</a></li>
        <li><a href={`/${lang}/about`} class="hover:text-bloom-pink transition-colors">{t(lang, 'nav.about')}</a></li>
        <li><a href={`/${lang}/contact`} class="hover:text-bloom-pink transition-colors">{t(lang, 'nav.contact')}</a></li>
        <li><LanguageSwitcher /></li>
      </ul>

      <!-- Mobile Navigation -->
      <MobileMenu lang={lang} />
    </div>
  </nav>
</header>
